<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>IBOCA Julio 2025 – Análisis Automático</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { color: #2c3e50; text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #3498db; color: white; }
    canvas { margin: 30px 0; max-width: 700px; display: block; margin-left: auto; margin-right: auto; }
    .card { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>IBOCA – Análisis Estadístico Julio 2025</h1>
  <div id="analisis"></div>
  <div id="graficos"></div>

  <script>
    // ==============================
    // Archivos esperados en el repositorio
    // ==============================
    const archivos = [
      "reporteIboca O3.xls",
      "reporteIboca PM10.xls",
      "reporteIboca PM2.5.xls"
    ];

    // Construir URL base del repositorio (ajusta TU_USUARIO y TU_REPO)
    const baseURL = "https://TU_USUARIO.github.io/TU_REPO/";

    async function cargarArchivos() {
      const datasets = {};
      for (const archivo of archivos) {
        const url = baseURL + archivo;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("No se pudo cargar " + archivo);
          const data = await response.arrayBuffer();
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: null });

          // Estación = nombre del archivo sin extensión
          const estacion = archivo.replace(/\.(xls|xlsx)$/i, "");

          datasets[estacion] = {};
          json.forEach(row => {
            const fecha = row["Fecha"] || row["FECHA"];
            for (const key in row) {
              if (key.toUpperCase().includes("O3") || key.toUpperCase().includes("PM10") || key.toUpperCase().includes("PM2.5")) {
                if (!datasets[estacion][key]) {
                  datasets[estacion][key] = { type: "FeatureCollection", features: [] };
                }
                if (row[key] != null && row[key] !== "") {
                  datasets[estacion][key].features.push({
                    properties: { fecha: fecha, valor: parseFloat(row[key]) }
                  });
                }
              }
            }
          });
        } catch (err) {
          console.error("Error al cargar archivo:", archivo, err);
        }
      }
      generarAnalisis(datasets);
    }

    // ==============================
    // Funciones estadísticas
    // ==============================
    function analizarDatos(data, estacion, contaminante) {
      if (!data.features) return null;
      const valores = data.features.map(f => f.properties.valor).filter(v => !isNaN(v));
      if (!valores.length) return null;
      const sum = valores.reduce((a, b) => a + b, 0);
      const mean = sum / valores.length;
      return {
        estacion, contaminante,
        count: valores.length,
        min: Math.min(...valores).toFixed(2),
        max: Math.max(...valores).toFixed(2),
        mean: mean.toFixed(2),
        fechas: data.features.map(f => f.properties.fecha),
        valores
      };
    }

    function generarAnalisis(datasets) {
      let html = `<table>
        <tr><th>Estación</th><th>Contaminante</th><th>Registros</th><th>Promedio</th><th>Mínimo</th><th>Máximo</th></tr>`;
      const resultados = [];

      for (const estacion in datasets) {
        for (const contaminante in datasets[estacion]) {
          const res = analizarDatos(datasets[estacion][contaminante], estacion, contaminante);
          if (res) {
            resultados.push(res);
            html += `<tr>
              <td>${res.estacion}</td>
              <td>${res.contaminante}</td>
              <td>${res.count}</td>
              <td>${res.mean}</td>
              <td>${res.min}</td>
              <td>${res.max}</td>
            </tr>`;
          }
        }
      }
      html += `</table>`;
      document.getElementById("analisis").innerHTML = html;

      generarGraficos(resultados);
    }

    function generarGraficos(resultados) {
      document.getElementById("graficos").innerHTML = ""; // limpiar
      resultados.forEach(res => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<h3>${res.contaminante} — ${res.estacion}</h3><canvas></canvas>`;
        document.getElementById("graficos").appendChild(card);
        const ctx = card.querySelector("canvas").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: res.fechas,
            datasets: [{
              label: res.contaminante,
              data: res.valores,
              borderColor: "rgba(52, 152, 219, 0.8)",
              fill: false
            }]
          },
          options: {
            scales: {
              x: { title: { display: true, text: "Fecha" } },
              y: { title: { display: true, text: "Valor" } }
            }
          }
        });
      });
    }

    // ==============================
    // Ejecutar automáticamente al cargar la página
    // ==============================
    cargarArchivos();
  </script>
</body>
</html>
