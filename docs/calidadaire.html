<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calidad del Aire - Engativá</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    header {
      display: flex;
      align-items: center;
      background-color: #0D0D0D;
      color: white;
      padding: 5px 30px;
    }
    .logo-container img { height: 35px; }
    h1 { font-size: 20px; margin-left: 20px; }
    .content {
      padding: 20px;
    }
    .chart-container {
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
    }
    .stats {
      margin: 20px auto;
      max-width: 800px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }
    .analysis {
      margin: 20px auto;
      max-width: 800px;
      background: #eef5ff;
      padding: 15px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <!-- Encabezado -->
  <header>
    <div class="logo-container">
      <a href="index.html">
        <img src="imagenes/mapa.png" alt="Logo">
      </a>
    </div>
    <h1>
      <a href="index.html" style="text-decoration: none; color: white;">
        Calidad del Aire - Engativá
      </a>
    </h1>
  </header>

  <div class="content">
    <h2>Estaciones: Las Ferias y CDAR</h2>
    <p>Datos del mes de agosto de 2023.</p>

    <!-- Gráficos -->
    <div class="chart-container">
      <canvas id="chartPM25"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartPM10"></canvas>
    </div>

    <!-- Estadísticas -->
    <div class="stats" id="stats"></div>

    <!-- Análisis -->
    <div class="analysis" id="analysis"></div>
  </div>

  <script>
    const url = "http://iboca.ambientebogota.gov.co:8080/geoserver/sda_ca/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=sda_ca:calidad_aire&outputFormat=application/json";

    async function getData() {
      try {
        const response = await fetch(url);
        const data = await response.json();

        const estaciones = ["LAS FERIAS", "CDAR"];
        const registros = data.features.filter(f => {
          const nombre = f.properties.estacion.toUpperCase();
          const fecha = new Date(f.properties.fecha);
          return estaciones.includes(nombre) &&
                 fecha.getMonth() === 7 &&  // Agosto (mes 7 en JS)
                 fecha.getFullYear() === 2023;
        });

        const resultados = {};
        estaciones.forEach(est => resultados[est] = []);

        registros.forEach(f => {
          const est = f.properties.estacion.toUpperCase();
          resultados[est].push({
            fecha: f.properties.fecha,
            pm10: f.properties.pm10,
            pm25: f.properties.pm25
          });
        });

        mostrarGraficos(resultados);
        mostrarEstadisticas(resultados);
        mostrarAnalisis(resultados);

      } catch (err) {
        console.error("Error cargando datos:", err);
      }
    }

    function mostrarGraficos(datos) {
      const labels = [...new Set(datos["LAS FERIAS"].map(d => d.fecha))];

      // PM2.5
      const datasetLF25 = datos["LAS FERIAS"].map(d => d.pm25);
      const datasetCDAR25 = datos["CDAR"].map(d => d.pm25);

      new Chart(document.getElementById("chartPM25"), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: "PM2.5 - Las Ferias", data: datasetLF25, borderColor: "red", fill: false },
            { label: "PM2.5 - CDAR", data: datasetCDAR25, borderColor: "blue", fill: false }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // PM10
      const datasetLF10 = datos["LAS FERIAS"].map(d => d.pm10);
      const datasetCDAR10 = datos["CDAR"].map(d => d.pm10);

      new Chart(document.getElementById("chartPM10"), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: "PM10 - Las Ferias", data: datasetLF10, borderColor: "orange", fill: false },
            { label: "PM10 - CDAR", data: datasetCDAR10, borderColor: "green", fill: false }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function mostrarEstadisticas(datos) {
      const statsDiv = document.getElementById("stats");

      let html = "<h3>Estadísticas Básicas (PM10 y PM2.5)</h3>";

      Object.keys(datos).forEach(est => {
        const valores25 = datos[est].map(d => d.pm25).filter(v => v != null);
        const promedio25 = (valores25.reduce((a,b) => a+b, 0) / valores25.length).toFixed(2);
        const max25 = Math.max(...valores25).toFixed(2);
        const min25 = Math.min(...valores25).toFixed(2);

        const valores10 = datos[est].map(d => d.pm10).filter(v => v != null);
        const promedio10 = (valores10.reduce((a,b) => a+b, 0) / valores10.length).toFixed(2);
        const max10 = Math.max(...valores10).toFixed(2);
        const min10 = Math.min(...valores10).toFixed(2);

        html += `<p><b>${est}</b><br>
                  PM2.5 → Promedio: ${promedio25} µg/m³ | Máx: ${max25} | Mín: ${min25}<br>
                  PM10 → Promedio: ${promedio10} µg/m³ | Máx: ${max10} | Mín: ${min10}</p>`;
      });

      statsDiv.innerHTML = html;
    }

    function mostrarAnalisis(datos) {
      const div = document.getElementById("analysis");

      div.innerHTML = `
        <h3>Análisis</h3>
        <p>
        Durante agosto de 2023, los valores de <b>PM2.5</b> y <b>PM10</b> en las estaciones de 
        <i>Las Ferias</i> y <i>CDAR</i> muestran variaciones asociadas al tránsito vehicular y a 
        las condiciones meteorológicas de la localidad de Engativá. 
        </p>
        <p>
        En general, los niveles promedio de PM2.5 se mantienen en rangos que pueden afectar la salud 
        de grupos vulnerables (niños, adultos mayores y personas con enfermedades respiratorias), 
        especialmente en sectores residenciales densos como el barrio <b>Bosque Popular</b>, que 
        está rodeado de vías de alta circulación (Av. Boyacá, Calle 63). 
        </p>
        <p>
        Los valores de <b>PM10</b>, aunque menos críticos que el PM2.5 en términos de penetración 
        pulmonar, también reflejan episodios de contaminación que pueden reducir la calidad del aire 
        en espacios abiertos y recreativos cercanos al barrio, como el parque Simón Bolívar y zonas 
        verdes de Engativá. 
        </p>
        <p>
        En conclusión, aunque los promedios no superen de manera constante los límites normativos, 
        la exposición prolongada a estas concentraciones representa un riesgo crónico, lo que 
        evidencia la necesidad de fortalecer políticas de movilidad sostenible y estrategias de 
        reducción de emisiones en la zona. 
        </p>
      `;
    }

    getData();
  </script>

</body>
</html>
